install.packages("Rtsne")
install.packages("uwot")
# Install flowCore
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("flowCore")
# Install CellVizR
install.packages("devtools")
library("devtools")
install_github("tchitchek-lab/CellVizR")
library(CellVizR)
# Read the vignette
library(flowCore)
browseVignettes("flowCore")


setwd("~/advanced_cytometry")

files <- list.files("./02_data/01_fcs/", 
                    pattern = "fcs",
                    full.names = TRUE)

# import the FCS files into a Celldata object 
DataCell <- import(files, 
                   filetype = "fcs", 
                   transform = "arcsinh",
                   exclude.markers = c("Cell_length","Dead","Beads","Cells","CD38","HLADR","CD14","CD62L","Bcl-6","IgD","B5R","CD195","CD138","CD95","TNFa","IL10"),
                   d.method = "uniform",
                   parameters.method = list("target.percent" = 0.1))


# Retrieving of the marker names
QCN <- QCMarkerNames(files)




plot = QCMarkerRanges(files)

plot <- ggiraph::girafe(ggobj = plot,
                        options = list(ggiraph::opts_sizing(width = .9),
                                       ggiraph::opts_hover_inv(css = "opacity:0.6;"),
                                       ggiraph::opts_hover(css = "fill:black;")))

plot
DataCell@raw.markers


#Metadata
metadata <- data.frame(individual = gsub("\\.fcs", "", basename(files)))
metadata$condition <- sapply(strsplit(metadata$individual, "_"), function(x) x[1])
metadata$individual <- sapply(strsplit(metadata$individual, "_"), function(x) x[2])
rownames(metadata) <- paste(metadata$condition, metadata$individual, sep = "_")
DataCell <- assignMetadata(DataCell, metadata = metadata)

#Metadata with timepoint
metadata <- data.frame(individual = gsub("\\.fcs", "", basename(files)))
metadata$condition <- sapply(strsplit(metadata$individual, "_"), function(x) x[1])
metadata$parsed_individual <- sapply(strsplit(metadata$individual, "_"), function(x) ifelse(length(x) >= 2, x[2], NA))
metadata$timepoint <- sapply(strsplit(metadata$individual, "_"), function(x) ifelse(length(x) >= 3, x[3], NA))
metadata$parsed_individual[is.na(metadata$parsed_individual)] <- "Unknown"
metadata$timepoint[is.na(metadata$timepoint)] <- "Unknown"
metadata$individual <- metadata$parsed_individual
rownames(metadata) <- rownames(DataCell@metadata)  # Ensure consistency with DataCell
metadata <- metadata[, c("condition", "individual", "timepoint")]
DataCell <- assignMetadata(DataCell, metadata = metadata)


# Perform Manifold from the "Celldata" object
DataCell <- generateManifold(DataCell,
                             method = "UMAP", 
                             n_neighbors = 15,
                             n_components = 2,
                             metric = "euclidean",
                             n_epochs = NULL,
                             n_threads = 1, 
                             n_sgd_threads = 1,
                             scale = FALSE)

#K-means
DataCell <- identifyClusters(DataCell, 
                             space = "manifold", 
                             method = "kmeans", 
                             centers = 100, 
                             nstart = 3)

#flowSOM
markers <- colnames(DataCell@matrix.expression)
DataCell <- identifyClusters(DataCell,
                             space = "markers",
                             markers = markers,
                             method = "FlowSOM",
                             nClus = 100,
                             xdim = 20,
                             ydim = 20)

plotClustersCounts(DataCell, 
                   clusters = NULL,
                   sort = TRUE)

#2_CLUSTER CONTROL
#Small clusters ?
QCS <- QCSmallClusters(DataCell,
                       th.size = 50, 
                       plot.device = TRUE)
#uniform clusters ? 
QCU <- QCUniformClusters(DataCell,
                         uniform.test = "both",
                         th.pvalue = 0.05,
                         th.IQR = 2,
                         plot.device = TRUE)

#Clusters' plot 
plotManifold(DataCell, 
             markers = "CD3",
             samples = NULL,
             downsampling = 200000)

#3_Heatmap
hm.exp <- plotHmExpressions(DataCell, 
                            metaclusters = 9)
gridExtra::grid.arrange(hm.exp)
plot(hm.exp)

#Heatmap with MOI
hm.exp <- plotHmExpressions(DataCell, 
                            markers = c("CD3", "CD127", "CD45RA", "CD20","CD21","CD22","CD27","CD80","IgG","IgM","CD23","CD40","CD197","Bcl2","CD69","CD279","Ki67"),
                            metaclusters = 9)
gridExtra::grid.arrange(hm.exp)
plot(hm.exp)

#Marker density
plotMarkerDensity(DataCell, 
                  clusters = "58")


#loop for creating UMAP for all conditions
pdf("./03_figures/umap_all_samples_plot.pdf", height = 8,width = 8)
for (sample in unique(DataCell@metadata$condition)){
  plotManifold(DataCell, sample = sample, markers = "clusters")+ 
    ggplot2::guides(color = "none")
}
dev.off()


#Volcanoplot

samples_baseline = selectSamples(DataCell, condition = "BPD19")
samples_PPD03 = selectSamples(DataCell, condition = "PPD03" )

DataCell <- computeStatistics(DataCell, 
                              condition = samples_PP, 
                              ref.condition = samples_baseline,
                              comparison = "samples_PPD03 vs. samples_baseline", 
                              test.statistics = "t.test",
                              paired = FALSE)

plotVolcano(DataCell,
            comparison = ("samples_PPD03 vs. samples_baseline"),
            th.pv = 1.3,
            th.fc = 1.5,
            plot.text = TRUE)
